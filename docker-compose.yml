services:
  # ClickHouse OLAP database
  clickhouse:
    image: clickhouse/clickhouse-server:24.3-alpine
    container_name: bikeshare-clickhouse
    restart: no
    security_opt:
      - seccomp:unconfined
    environment:
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-bikeshare}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-clickhouse}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./scripts/init_clickhouse.sql:/docker-entrypoint-initdb.d/init_clickhouse.sql
      - ./data:/usr/app/data
      - ./scripts:/usr/app/scripts
    networks:
      - bikeshare-network
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

  # dbt development environment
  dbt-dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bikeshare-dbt-dev
    restart: no
    working_dir: /usr/app/dbt_project
    volumes:
      - ./dbt_project:/usr/app/dbt_project
      - ./data:/usr/app/data
      - ./scripts:/usr/app/scripts
      - ./data_ingestion:/usr/app/data_ingestion
      - ./.env:/usr/app/.env
    environment:
      # Clickhouse Local Connection
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST:-clickhouse}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT:-8123}
      - CLICKHOUSE_DB=${CLICKHOUSE_DB:-bikeshare}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-default}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-clickhouse}
      - CLICKHOUSE_SECURE=${CLICKHOUSE_SECURE:-false}

      # Clickhouse Cloud Connection
      - CLICKHOUSE_CLOUD_HOST=${CLICKHOUSE_CLOUD_HOST}  
      - CLICKHOUSE_CLOUD_NATIVE_PORT=${CLICKHOUSE_CLOUD_NATIVE_PORT} 
      - CLICKHOUSE_CLOUD_USER=${CLICKHOUSE_CLOUD_USER} 
      - CLICKHOUSE_CLOUD_PASSWORD=${CLICKHOUSE_CLOUD_PASSWORD}
      
      - DBT_PROFILES_DIR=/usr/app/dbt_project
    ports:
      - "8080:8080"
    networks:
      - bikeshare-network
    command: ["tail", "-f", "/dev/null"]

volumes:
  clickhouse_data:
     driver: local

networks:
  bikeshare-network:
    driver: bridge